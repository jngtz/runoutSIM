<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Grid search optimization of runoutSIM with runoptGPP • runoutSIM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Grid search optimization of runoutSIM with runoptGPP">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">runoutSIM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/runoutSIM_basic_intro.html">A basic introduction to runoutSIM</a></li>
    <li><a class="dropdown-item" href="../articles/runoutSIM_optimize_w_runoptGPP.html">Grid search optimization of runoutSIM with runoptGPP</a></li>
    <li><a class="dropdown-item" href="../articles/runoutSIM_parallelization.html">Parallel computing with runoutSIM</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jngtz/runoutSim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Grid search optimization of runoutSIM with runoptGPP</h1>
                        <h4 data-toc-skip class="author">Jason
Goetz</h4>
            
            <h4 data-toc-skip class="date">2025-10-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jngtz/runoutSim/blob/HEAD/vignettes/runoutSIM_optimize_w_runoptGPP.Rmd" class="external-link"><code>vignettes/runoutSIM_optimize_w_runoptGPP.Rmd</code></a></small>
      <div class="d-none name"><code>runoutSIM_optimize_w_runoptGPP.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://github.com/jngtz/runoptGPP" class="external-link"><code>runoptGPP</code></a> is
an R package developed for optimizing the random walk (path/dispersion)
and PCM (distance) components of mass-movement runout simulations. It
provides functions to perform grid search optimization, evaluate
performance metrics, and visualize results - with support for
<code>runoutSIM</code>.</p>
<p>The optimization follows a two-stage approach:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Optimize random walk model</strong> for best path
simulation.</p></li>
<li><p><strong>Optimize PCM model</strong> for best runout distance
using the previously optimized path.</p></li>
</ol>
<p>Performance is evaluated using AUROC for path accuracy, and relative
runout distance error for distance modeling (see <a href="https://nhess.copernicus.org/articles/21/2543/2021/" class="external-link">Goetz et
al. 2021, NHESS</a>).</p>
<p>This vignette covers:</p>
<ul>
<li><p>Installing <code>runoptGPP</code> from GitHub</p></li>
<li><p>Finding optimal global parameters using grid search</p></li>
<li><p>Performing spatial cross-validation to assess model
sensitivity</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="installing-runoptgpp">Installing <code>runoptGPP</code><a class="anchor" aria-label="anchor" href="#installing-runoptgpp"></a>
</h2>
<p><code>runoptGPP</code> is not currently available on CRAN. To install
it directly from GitHub, use:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"jngtz/runoptGPP"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="loading-packages-and-input-data">Loading packages and input data<a class="anchor" aria-label="anchor" href="#loading-packages-and-input-data"></a>
</h2>
<p>We begin by loading the required packages, a digital elevation model
(DEM), and vector data for debris-flow source points and mapped runout
polygons.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jngtz/runoutSim" class="external-link">runoutSIM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">runoptGPP</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'terra' was built under R version 4.4.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'sf' was built under R version 4.4.3</span></span>
<span></span>
<span><span class="co"># Load digital elevation model (DEM)</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"Data/elev_fillsinks_WangLiu.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute hillshade for visualization </span></span>
<span><span class="va">slope</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/terrain.html" class="external-link">terrain</a></span><span class="op">(</span><span class="va">dem</span>, <span class="st">"slope"</span>, unit<span class="op">=</span><span class="st">"radians"</span><span class="op">)</span></span>
<span><span class="va">aspect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/terrain.html" class="external-link">terrain</a></span><span class="op">(</span><span class="va">dem</span>, <span class="st">"aspect"</span>, unit<span class="op">=</span><span class="st">"radians"</span><span class="op">)</span></span>
<span><span class="va">hill</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/shade.html" class="external-link">shade</a></span><span class="op">(</span><span class="va">slope</span>, <span class="va">aspect</span>, <span class="fl">40</span>, <span class="fl">270</span>, normalize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load debris flow runout source points and polygons</span></span>
<span><span class="va">source_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"Data/debris_flow_source_points.shp"</span><span class="op">)</span></span>
<span><span class="va">runout_polygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"Data/debris_flow_runout_polygons.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot input data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hill</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html" class="external-link">grey</a></span><span class="op">(</span><span class="fl">150</span><span class="op">:</span><span class="fl">255</span><span class="op">/</span><span class="fl">255</span><span class="op">)</span>, legend<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>     mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dem</span>, col<span class="op">=</span><span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">mako</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">runout_polygons</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="runoutSIM_optimize_w_runoptGPP_files/figure-html/unnamed-chunk-2-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="section"></h2>
</div>
<div class="section level2">
<h2 id="optimizing-random-walk-parameters">Optimizing Random Walk Parameters<a class="anchor" aria-label="anchor" href="#optimizing-random-walk-parameters"></a>
</h2>
<div class="section level3">
<h3 id="step-1-define-the-parameter-search-space">Step 1: Define the parameter search space<a class="anchor" aria-label="anchor" href="#step-1-define-the-parameter-search-space"></a>
</h3>
<p>In our first stage of optimization, we will set up vectors to define
our grid search space for the random walk runout path model component.
This is an exhaustive list of the parameters that will be tested.</p>
<p>To simulate runout <em>paths</em>, we define a parameter grid
for:</p>
<ul>
<li><p><code>rwexp</code>: divergence exponent (controls
spread)</p></li>
<li><p><code>rwper</code>: persistence factor (controls
directionality)</p></li>
<li><p><code>rwslp</code>: slope threshold (affects frictional
resistance)</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">steps</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">rwexp_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1.3</span>, <span class="fl">3</span>, len<span class="op">=</span><span class="va">steps</span><span class="op">)</span> <span class="co"># Expondent of divergence</span></span>
<span><span class="va">rwper_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span>, len<span class="op">=</span><span class="va">steps</span><span class="op">)</span> <span class="co"># Persistence factor</span></span>
<span><span class="va">rwslp_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">40</span>, len<span class="op">=</span><span class="va">steps</span><span class="op">)</span> <span class="co"># Slope threshold</span></span>
<span></span>
<span><span class="va">rwexp_vec</span></span>
<span><span class="co">#&gt; [1] 1.300 1.725 2.150 2.575 3.000</span></span>
<span><span class="va">rwper_vec</span></span>
<span><span class="co">#&gt; [1] 1.500 1.625 1.750 1.875 2.000</span></span>
<span><span class="va">rwslp_vec</span></span>
<span><span class="co">#&gt; [1] 20 25 30 35 40</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-parallelize-the-grid-search">Step 2: Parallelize the grid search<a class="anchor" aria-label="anchor" href="#step-2-parallelize-the-grid-search"></a>
</h3>
<p>We use the <code>foreach</code> and <code>doParallel</code> packages
to speed up model runs by distributing them across multiple CPU cores.
For each mapped runout polygon, all combinations of parameters are
evaluated using the <code><a href="https://rdrr.io/pkg/runoptGPP/man/rwGridsearch.html" class="external-link">rwGridsearch()</a></code> function.</p>
<p>Depending on the number of runout events and the grid search space
size, this computation can take some time. The <code>rwGridsearch</code>
function has an option <code>save_res = TRUE</code> that allows us to
save the grid search results for each runout individually. This is
useful in the case where processing fails since it avoids the need to
re-run the grid search for all runout events.</p>
<p>In this example we are creating a limited grid search space
(i.e. only 4<em>4</em>4 possible parameter combinations) to reduce
computational time.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="va">polyid_vec</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">source_points</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span><span class="fl">2</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Coerce dem to raster() dem.</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rw_gridsearch_multi</span>  <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>poly_id<span class="op">=</span><span class="va">polyid_vec</span>, .packages<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'terra'</span>,<span class="st">'raster'</span>, <span class="st">'ROCR'</span>, <span class="st">'sf'</span>, <span class="st">'runoptGPP'</span>, <span class="st">'runoutSIM'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/rwGridsearch.html" class="external-link">rwGridsearch</a></span><span class="op">(</span><span class="va">dem</span>, slide_plys <span class="op">=</span> <span class="va">runout_polygons</span>, slide_src <span class="op">=</span> <span class="va">source_points</span>,</span>
<span>                 slide_id <span class="op">=</span> <span class="va">poly_id</span>, slp_v <span class="op">=</span> <span class="va">rwslp_vec</span>, ex_v <span class="op">=</span> <span class="va">rwexp_vec</span>, </span>
<span>                 per_v <span class="op">=</span> <span class="va">rwper_vec</span>, gpp_iter <span class="op">=</span> <span class="fl">1000</span>, buffer_ext <span class="op">=</span> <span class="fl">500</span>, buffer_source <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                 save_res <span class="op">=</span> <span class="cn">TRUE</span>, plot_eval <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-get-the-optimal-parameters">Step 3: Get the optimal parameters<a class="anchor" aria-label="anchor" href="#step-3-get-the-optimal-parameters"></a>
</h3>
<p>We extract the optimal parameters across all runouts by aggregating
their performance (here, using the median AUROC).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rw_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/rwGetOpt.html" class="external-link">rwGetOpt</a></span><span class="op">(</span><span class="va">rw_gridsearch_multi</span>, </span>
<span>                   measure <span class="op">=</span> <span class="va">median</span><span class="op">)</span></span>
<span><span class="va">rw_opt</span></span>
<span><span class="co">#&gt;   rw_slp_opt rw_exp_opt rw_per_opt  rw_auroc</span></span>
<span><span class="co">#&gt; 1         40          3      1.875 0.8748927</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="optimizing-pcm-parameters-runout-distance">Optimizing PCM Parameters (Runout Distance)<a class="anchor" aria-label="anchor" href="#optimizing-pcm-parameters-runout-distance"></a>
</h2>
<div class="section level3">
<h3 id="step-1-define-the-parameter-space">Step 1: Define the parameter space<a class="anchor" aria-label="anchor" href="#step-1-define-the-parameter-space"></a>
</h3>
<p>We now define grid vectors for:</p>
<ul>
<li>
<code>pcmmd</code>: mass-to-drag ratio (affects how far material
travels)</li>
<li>
<code>pcmmu</code>: sliding friction coefficient</li>
</ul>
<p>In this example we are creating a limited grid search space
(i.e. only 20*10 possible parameter combinations) to reduce
computational time.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define PCM model grid seach space</span></span>
<span><span class="va">pcmmd_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">140</span>, by<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="co"># mass-to-drag ratio (m)</span></span>
<span><span class="va">pcmmu_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, by<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="co"># sliding friction coefficient </span></span>
<span></span>
<span><span class="va">pcmmd_vec</span></span>
<span><span class="co">#&gt; [1]  20  40  60  80 100 120 140</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-run-pcm-grid-search-in-parallel">Step 2: Run PCM grid search in parallel<a class="anchor" aria-label="anchor" href="#step-2-run-pcm-grid-search-in-parallel"></a>
</h3>
<p>Here, we re-use parallelization to optimize the PCM model using the
previously selected random walk parameters. Each runout is simulated
independently.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run using parallelization</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span><span class="fl">2</span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pcm_gridsearch_multi</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>poly_id<span class="op">=</span><span class="va">polyid_vec</span>, .packages<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'terra'</span>,<span class="st">'raster'</span>, <span class="st">'ROCR'</span>, <span class="st">'sf'</span>, <span class="st">'runoptGPP'</span>, <span class="st">'runoutSIM'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/pcmGridsearch.html" class="external-link">pcmGridsearch</a></span><span class="op">(</span><span class="va">dem</span>,</span>
<span>                  slide_plys <span class="op">=</span> <span class="va">runout_polygons</span>, slide_src <span class="op">=</span> <span class="va">source_points</span>, </span>
<span>                  slide_id <span class="op">=</span> <span class="va">poly_id</span>, rw_slp <span class="op">=</span> <span class="fl">40</span>, rw_ex <span class="op">=</span> <span class="fl">3</span>, rw_per <span class="op">=</span> <span class="fl">1.9</span>, </span>
<span>                  pcm_mu_v <span class="op">=</span> <span class="va">pcmmu_vec</span>, pcm_md_v <span class="op">=</span> <span class="va">pcmmd_vec</span>,</span>
<span>                  gpp_iter <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                  buffer_ext <span class="op">=</span> <span class="cn">NULL</span>, buffer_source <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                  predict_threshold <span class="op">=</span> <span class="fl">0.5</span>, save_res <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-extract-optimal-pcm-parameters">Step 3: Extract optimal PCM parameters<a class="anchor" aria-label="anchor" href="#step-3-extract-optimal-pcm-parameters"></a>
</h3>
<p>We find the PCM parameter set that results in the <strong>lowest
median relative error</strong> across all simulated runouts. This gives
us a regionally optimized distance model. The median model performances
across grid search space can be visualized using
<code>plot_opt=TRUE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/pcmGetOpt.html" class="external-link">pcmGetOpt</a></span><span class="op">(</span><span class="va">pcm_gridsearch_multi</span>, </span>
<span>          performance <span class="op">=</span> <span class="st">"relerr"</span>, </span>
<span>          measure <span class="op">=</span> <span class="st">"median"</span>, </span>
<span>          plot_opt <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pcm_mu pcm_md median_relerr median_auroc</span></span>
<span><span class="co">#&gt; 1   0.04     40    0.03576527    0.9042586</span></span></code></pre></div>
<p><img src="runoutSIM_optimize_w_runoptGPP_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-cross-validation-of-parameters">Spatial Cross-Validation of Parameters<a class="anchor" aria-label="anchor" href="#spatial-cross-validation-of-parameters"></a>
</h2>
<p>To evaluate the sensitivity of our optimal parameters to spatial
sampling, we apply <strong>spatial cross-validation</strong> using
k-means partitioning from the <code>sperrorest</code> package. This
simulates training/testing under different spatial configurations.</p>
<p>We run 5-fold cross-validation with 10 repetitions using the results
from the random walk and PCM grid searches.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rw_spcv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/rwSPCV.html" class="external-link">rwSPCV</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rw_gridsearch_multi</span>, slide_plys <span class="op">=</span> <span class="va">runout_polygons</span>,</span>
<span>                  n_folds <span class="op">=</span> <span class="fl">5</span>, repetitions <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">freq_rw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/rwPoolSPCV.html" class="external-link">rwPoolSPCV</a></span><span class="op">(</span><span class="va">rw_spcv</span>, plot_freq <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pcm_spcv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/pcmSPCV.html" class="external-link">pcmSPCV</a></span><span class="op">(</span><span class="va">pcm_gridsearch_multi</span>, slide_plys <span class="op">=</span> <span class="va">runout_polygons</span>,</span>
<span>                    n_folds <span class="op">=</span> <span class="fl">5</span>, repetitions <span class="op">=</span> <span class="fl">10</span>, from_save <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">freq_pcm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/runoptGPP/man/pcmPoolSPCV.html" class="external-link">pcmPoolSPCV</a></span><span class="op">(</span><span class="va">pcm_spcv</span>, plot_freq <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">freq_rw</span></span>
<span><span class="co">#&gt;   slp   per exp freq rel_freq median_auroc   iqr_auroc</span></span>
<span><span class="co">#&gt; 1  40 1.500   3    9       18    0.8843889 0.020861264</span></span>
<span><span class="co">#&gt; 2  40 1.625   3    7       14    0.8215202 0.080693418</span></span>
<span><span class="co">#&gt; 3  40 1.750   3    7       14    0.9083694 0.005970888</span></span>
<span><span class="co">#&gt; 4  40 1.875   3   24       48    0.8619509 0.029733802</span></span>
<span><span class="co">#&gt; 5  40 2.000   3    3        6    0.8119542 0.000000000</span></span>
<span><span class="va">freq_pcm</span></span>
<span><span class="co">#&gt;     mu  md freq rel_freq    rel_err  iqr_relerr</span></span>
<span><span class="co">#&gt; 1 0.04  40   35       70 0.05290689 0.049399707</span></span>
<span><span class="co">#&gt; 2 0.05  40    9       18 0.03205946 0.004627829</span></span>
<span><span class="co">#&gt; 3 0.07  40    3        6 0.07844790 0.000000000</span></span>
<span><span class="co">#&gt; 4 0.09 100    3        6 0.04196954 0.000000000</span></span></code></pre></div>
<p><img src="runoutSIM_optimize_w_runoptGPP_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;"><img src="runoutSIM_optimize_w_runoptGPP_files/figure-html/unnamed-chunk-11-2.png" width="672" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jason Goetz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
